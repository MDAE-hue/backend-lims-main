openapi: 3.0.0
info:
  title: LIMS API Documentation
  description: |
    Dokumentasi API untuk sistem LIMS (Laboratory Information Management System) PT KPI.

    **Langkah-langkah menguji API:**
    1. **Login**:  
        - Endpoint: `POST /login`  
        - Input: `username` dan `password`  
        - Response: Akan mengembalikan `token` (JWT).

    2. **Ambil Token**:  
        - Salin `token` dari response login.

    3. **Input Token di Authorization**:  
        - **Swagger UI**:
          1. Klik tombol **Authorize** (ikon gembok) di kanan atas Swagger UI.  
          2. Masukkan `token`.
          3. Klik **Authorize** lalu **Close**.  
        - **Postman**:
          1. Pilih tab **Authorization** di request.  
          2. Pilih tipe **Bearer Token**.  
          3. Paste `token` di kolom token.  

    4. **Uji Endpoint Lain**:  
        - Setelah token valid, semua endpoint yang membutuhkan autentikasi dapat diakses.  
        - Pastikan token belum expired.
  version: 1.0.0

servers:
  - url: http://localhost:8000/api
    description: Local backend server

tags:
  - name: Auth
    description: Endpoint untuk Login
  - name: Users
    description: Endpoint untuk Users
  - name: Roles
    description: Endpoint untuk Roles
  - name: Departments
    description: Endpoint untuk Departments
  - name: Reports
    description: Endpoint untuk Reports
  - name: Test
    description: Endpoint untuk Test (Hasil tes dari laboratory report)

security:
  - BearerAuth: []

paths:
  # ================= Auth =================
  /login:
    post:
      tags:
        - Auth
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login berhasil, token dikembalikan
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      name:
                        type: string
                      email:
                        type: string
                      department_id:
                        type: integer
                      roles:
                        type: array
                        items:
                          type: string
        '401':
          description: Email atau password salah
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  # ================= Users =================
  /users:
    get:
      tags:
        - Users
      summary: Ambil semua user
      responses:
        '200':
          description: List user berhasil diambil
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'

    post:
      tags:
        - Users
      summary: Tambah user baru
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: User berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Ambil user berdasarkan ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User tidak ditemukan
          content:
            application/json:
              example:
                message: User not found

    put:
      tags:
        - Users
      summary: Update user
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: User berhasil diupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    delete:
      tags:
        - Users
      summary: Hapus user
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User berhasil dihapus
          content:
            application/json:
              example:
                message: User deleted successfully

  /users/{id}/assign-role:
    post:
      tags:
        - Users
      summary: Assign atau update roles user
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                roles:
                  type: array
                  items:
                    type: integer
      responses:
        '200':
          description: Roles berhasil diupdate

  /users/change-password:
    post:
      tags:
        - Users
      summary: Ganti password user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                oldPassword:
                  type: string
                newPassword:
                  type: string
      responses:
        '200':
          description: Password berhasil diubah
        '400':
          description: Password lama salah
        '401':
          description: Unauthorized

  # ================= Roles =================
  /roles:
    get:
      tags:
        - Roles
      summary: Ambil semua role
      responses:
        '200':
          description: List role berhasil diambil
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

    post:
      tags:
        - Roles
      summary: Tambah role baru
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreate'
      responses:
        '201':
          description: Role berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'

  /roles/{id}:
    get:
      tags:
        - Roles
      summary: Ambil role berdasarkan ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Role berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '404':
          description: Role tidak ditemukan
          content:
            application/json:
              example:
                message: Role not found

    put:
      tags:
        - Roles
      summary: Update role
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdate'
      responses:
        '200':
          description: Role berhasil diupdate

    delete:
      tags:
        - Roles
      summary: Hapus role
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Role berhasil dihapus

  /departments:
    get:
      tags:
        - Departments
      summary: Ambil semua department
      description: Mengambil list semua department dari database
      responses:
        '200':
          description: List department berhasil diambil
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Department'
        '500':
          description: Terjadi kesalahan server
          content:
            application/json:
              example:
                error: "Failed to fetch departments"
                message: "Error message here"

  /laboratory/reports:
    get:
      tags: [Reports]
      summary: Ambil semua report
      responses:
        '200':
          description: List report berhasil diambil
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Report'
    post:
      tags: [Reports]
      summary: Buat report baru
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                location:
                  type: string
                remark:
                  type: string
                notes:
                  type: string
      responses:
        '201':
          description: Report berhasil dibuat
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /laboratory/reports/{id}:
    get:
      tags: [Reports]
      summary: Ambil report berdasarkan ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Report berhasil diambil
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
    put:
      tags: [Reports]
      summary: Update report
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                location:
                  type: string
                remark:
                  type: string
                notes:
                  type: string
                status_id:
                  type: integer
                date_sampling:
                  type: string
                  format: date
                date_analysis:
                  type: string
                  format: date
      responses:
        '200':
          description: Report berhasil diupdate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
    delete:
      tags: [Reports]
      summary: Hapus report
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Report berhasil dihapus
          content:
            application/json:
              example:
                message: Report deleted successfully

  /laboratory/reports/{id}/take-action:
    get:
      tags: [Reports]
      summary: Ambil data untuk take action
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Report & daftar subordinates
    put:
      tags: [Reports]
      summary: Assign sampler & analyst
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sampler_id:
                  type: integer
                analyst_id:
                  type: integer
                remark:
                  type: string
                notes:
                  type: string
      responses:
        '200':
          description: Report updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /laboratory/reports/{id}/finalize:
    put:
      tags: [Reports]
      summary: Finalisasi report
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Report berhasil difinalisasi
        '400':
          description: Report belum bisa difinalisasi

  /laboratory/reports/{id}/review:
    get:
      tags: [Reports]
      summary: Ambil detail report untuk review
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Detail report & test details
          content:
            application/json:
              schema:
                type: object
                properties:
                  report:
                    $ref: '#/components/schemas/Report'
                  test_details:
                    type: array
                    items:
                      type: object

  /laboratory/reports/{id}/submit-review:
    put:
      tags: [Reports]
      summary: Submit review
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [approve, revision]
                comment:
                  type: string
      responses:
        '200':
          description: Review berhasil disubmit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /laboratory/reports/{id}/approve:
    put:
      tags: [Reports]
      summary: Approve report (close)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Report berhasil diapprove

  /laboratory/reports/{id}/generate-coa:
    get:
      tags: [Reports]
      summary: Generate CoA PDF
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: PDF CoA berhasil di-generate
          content:
            application/pdf:
              schema:
                type: string
                format: binary

  /laboratory/reports/{id}/reject:
    post:
      tags: [Reports]
      summary: Reject report
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Report berhasil direject
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'

  /laboratory/reports/{report_id}/test-details:
    get:
      tags: [Test]
      summary: Ambil semua test details berdasarkan report_id
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List test details
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /laboratory/reports/{report_id}/test-details-view:
    get:
      tags: [Test]
      summary: Ambil test details dengan join master data
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List test details lengkap
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /test-details:
    post:
      tags: [Test]
      summary: Simpan test detail baru
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestDetail'
      responses:
        '201':
          description: Test detail berhasil disimpan

  /test-details/{id}:
    put:
      tags: [Test]
      summary: Update test detail
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestDetail'
      responses:
        '200':
          description: Test detail berhasil diperbarui

  /test-types:
    get:
      tags: [Test]
      summary: Ambil semua test types
      responses:
        '200':
          description: List test types

  /methods:
    get:
      tags: [Test]
      summary: Ambil semua methods
      responses:
        '200':
          description: List methods

  /standards:
    get:
      tags: [Test]
      summary: Ambil semua standards
      responses:
        '200':
          description: List standards

  /units:
    get:
      tags: [Test]
      summary: Ambil semua units
      responses:
        '200':
          description: List units

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ===== Users =====
    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
        npk:
          type: string
          nullable: true
        job_title:
          type: string
          nullable: true
        department:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        superiorUser:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        roles:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
    UserCreate:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        password:
          type: string
        department_id:
          type: integer
        npk:
          type: string
          nullable: true
        job_title:
          type: string
          nullable: true
        superior:
          type: integer
          nullable: true
        roles:
          type: array
          items:
            type: integer
    UserUpdate:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        password:
          type: string
        department_id:
          type: integer
          nullable: true
        npk:
          type: string
          nullable: true
        job_title:
          type: string
          nullable: true
        superior:
          type: integer
          nullable: true
        roles:
          type: array
          items:
            type: integer

    # ===== Roles =====
    Role:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
    RoleCreate:
      type: object
      properties:
        name:
          type: string
    RoleUpdate:
      type: object
      properties:
        name:
          type: string

    # ===== Departments =====
    Department:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string

    # ===== Reports =====
    Report:
      type: object
      properties:
        id:
          type: integer
        no_report:
          type: string
        requested_by:
          type: integer
        requested_by_name:
          type: string
        department_id:
          type: integer
        department:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        sampler:
          type: integer
        sampler_name:
          type: string
        analyst:
          type: integer
        analyst_name:
          type: string
        reviewed_by:
          type: integer
        reviewed_by_name:
          type: string
        acknowledge_by:
          type: integer
        acknowledge_by_name:
          type: string
        location:
          type: string
        remark:
          type: string
        notes:
          type: string
        status_id:
          type: integer
        status:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
  
    TestDetail:
      type: object
      properties:
        id:
          type: integer
        report_id:
          type: integer
        bahan_pengujian:
          type: string
          nullable: true
        test_type_id:
          type: integer
          nullable: true
        test_type:
          type: string
          nullable: true
        method_id:
          type: integer
          nullable: true
        method:
          type: string
          nullable: true
        standard_id:
          type: integer
          nullable: true
        standard:
          type: string
          nullable: true
        unit_id:
          type: integer
          nullable: true
        unit:
          type: string
          nullable: true
        result:
          type: string
          nullable: true
        description:
          type: string
          nullable: true